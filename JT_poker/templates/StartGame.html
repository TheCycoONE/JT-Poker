<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Welcome to the Game</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KyZXEAg3QhqLMpG8r+Knujsl7/2D2e92ZB3fCtvJd2Dt+koWvEcX77pq6iX7z0gO" crossorigin="anonymous">
    <style>
        #messages div {
            font-size: 1.5rem; /* Larger font size for messages */
        }
    </style>
</head>
<body>
<div class="container mt-3">
    <h1>Welcome to the Game</h1>
    <div id="messages" class="border rounded p-3 mb-3" style="height: 300px; overflow-y: scroll;">
        <!-- Messages will be appended here dynamically -->
        {% for message in messages %}
            <div><p>{{ message }}</p></div>
        {% endfor %}
    </div>
    <p>{{ game_output }}</p>
    <p id="ws-url"></p> <!-- Display the WebSocket URL on the page -->
    <form id="game-form" method="post" action="{% url 'start_game' %}">
        {% csrf_token %}
        <button type="submit" name="play" class="btn btn-primary">Play</button>
        <button type="submit" name="spectate" class="btn btn-secondary">Spectate</button>
    </form>
</div>

<!-- Bootstrap Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
<script>
    // Construct the WebSocket URL
    const wsUrl = 'ws://' + window.location.host + '/ws/playPoker/';

    // Log the WebSocket URL to the console
    console.log('WebSocket URL:', wsUrl);

    // Ensure the element exists before setting its content
    const wsUrlElement = document.getElementById('ws-url');
    if (wsUrlElement) {
        wsUrlElement.textContent = 'WebSocket URL: ' + wsUrl;
    }

    // Create the WebSocket connection
    const chatSocket = new WebSocket(wsUrl);
    let displayedMessages = [];

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const messages = document.getElementById('messages');
        messages.innerHTML = '';  // Clear the existing messages
        displayedMessages = data.messages.slice(-20);  // Keep only the last 20 messages
        displayMessagesWithDelay(displayedMessages, messages);
    };

    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };

    function startGame() {
        const playButton = document.querySelector('button[name="play"]');
        playButton.click();
    }

    function spectateGame() {
        const spectateButton = document.querySelector('button[name="spectate"]');
        spectateButton.click();
    }

    function updateMessages() {
        if (chatSocket.readyState === WebSocket.OPEN) {
            chatSocket.send(JSON.stringify({
                'type': 'fetch_messages'
            }));
        }
    }

    function displayMessagesWithDelay(messages, container) {
        let index = 0;

        function showNextMessage() {
            if (index < messages.length) {
                const messageDiv = document.createElement('div');
                messageDiv.textContent = messages[index];
                container.appendChild(messageDiv);
                container.scrollTop = container.scrollHeight;
                index++;
                setTimeout(showNextMessage, 2000); // Adjust delay as needed (e.g., 2000ms = 2 seconds)
            }
        }

        showNextMessage();
    }

    setInterval(updateMessages, 5000); // Update every 5 seconds to fetch new messages
</script>
</body>
</html>